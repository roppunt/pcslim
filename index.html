<?php
/* ---------------------------------------------------------
   PC-Slim ‚Äì index.php met bereikbaarheid op basis van ICS
   ---------------------------------------------------------
   - Zet je pagina online als index.php (niet index.html)
   - Pas $ICS_URL en openingstijden (09:00‚Äì18:00) naar wens aan
   - Cache: 60 seconden
--------------------------------------------------------- */

declare(strict_types=1);

/* ==== Instellingen ==== */
$ICS_URL = "https://export.calendar.online/ics/2229257/13e2e96533a8b26a68d6/werkplanner.ics?past_months=3&future_months=36";
$OPEN_FROM = 9;   // 09:00
$OPEN_TILL = 18;  // 18:00
$CACHE_SECONDS = 60;

/* ==== Helpers ==== */
function pcs_fetch_url(string $url): ?string {
  $ch = curl_init($url);
  curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_CONNECTTIMEOUT => 6,
    CURLOPT_TIMEOUT => 10,
    CURLOPT_USERAGENT => 'PC-Slim Availability',
  ]);
  $body = curl_exec($ch);
  $ok = ($body !== false) && (curl_getinfo($ch, CURLINFO_HTTP_CODE) < 400);
  curl_close($ch);
  return $ok ? $body : null;
}

function pcs_str_ends_with(string $haystack, string $needle): bool {
  if ($needle === '') return true;
  $needleLength = strlen($needle);
  return $needleLength <= strlen($haystack) && substr($haystack, -$needleLength) === $needle;
}

function pcs_parse_ics_datetime(string $value, ?string $tzid, bool $isDateOnly): ?DateTime {
  $defaultTz = new DateTimeZone(date_default_timezone_get());

  if ($isDateOnly) {
    $dt = DateTime::createFromFormat('Ymd', $value, $tzid ? new DateTimeZone($tzid) : $defaultTz);
    if (!$dt) return null;
    $dt->setTimezone($defaultTz);
    return $dt;
  }

  $hasZulu = pcs_str_ends_with($value, 'Z');
  if ($hasZulu) {
    $value = substr($value, 0, -1);
  }

  $sourceTz = $tzid ? new DateTimeZone($tzid) : ($hasZulu ? new DateTimeZone('UTC') : $defaultTz);
  $dt = DateTime::createFromFormat('Ymd\THis', $value, $sourceTz);
  if (!$dt) return null;
  $dt->setTimezone($defaultTz);
  return $dt;
}

function pcs_parse_ics_events(string $ics): array {
  // Maak regels eenduidig en verwijder folded lines
  $ics = str_replace(["\r\n", "\r"], "\n", $ics);
  $ics = preg_replace("/\n[ \t]/", '', $ics);

  preg_match_all('/BEGIN:VEVENT(.*?)END:VEVENT/s', $ics, $blocks);
  $events = [];

  foreach ($blocks[1] as $event) {
    $start = $end = null;
    $startDateOnly = $endDateOnly = false;

    foreach (explode("\n", trim($event)) as $line) {
      $line = trim($line);
      if ($line === '' || strpos($line, ':') === false) continue;

      [$prop, $rawValue] = explode(':', $line, 2);
      $rawValue = trim($rawValue);
      $name = $prop;
      $tzid = null;
      $isDateOnly = false;

      if (strpos($prop, ';') !== false) {
        $pieces = explode(';', $prop);
        $name = array_shift($pieces);
        foreach ($pieces as $piece) {
          if (stripos($piece, 'TZID=') === 0) {
            $tzid = substr($piece, 5);
          } elseif (stripos($piece, 'VALUE=DATE') === 0) {
            $isDateOnly = true;
          }
        }
      }

      if ($name === 'DTSTART') {
        $start = pcs_parse_ics_datetime($rawValue, $tzid, $isDateOnly);
        $startDateOnly = $isDateOnly;
      } elseif ($name === 'DTEND') {
        $end = pcs_parse_ics_datetime($rawValue, $tzid, $isDateOnly);
        $endDateOnly = $isDateOnly;
      }
    }

    if ($start && $end) {
      if ($startDateOnly) {
        $start->setTime(0, 0);
      }
      if ($endDateOnly) {
        $end->setTime(0, 0);
      }
      $events[] = ['start' => $start, 'end' => $end];
    }
  }

  usort($events, function ($a, $b) {
    return $a['start'] <=> $b['start'];
  });

  return $events;
}

function pcs_availability_label(array $events, int $openFrom, int $openTill): string {
  $now  = new DateTime();
  $hour = (int)$now->format('H');

  if ($hour < $openFrom) return "‚ùå Nog niet bereikbaar (vanaf " . sprintf("%02d:00", $openFrom) . ").";
  if ($hour >= $openTill) return "‚ùå Niet bereikbaar (na " . sprintf("%02d:00", $openTill) . ").";

  foreach ($events as $ev) {
    $bufferedEnd = (clone $ev['end'])->modify('+30 minutes'); // 30 min buffer
    if ($now >= $ev['start'] && $now <= $bufferedEnd) {
      return "‚ùå Op dit moment bezet (afspraak).";
    }
  }
  return "‚úÖ Nu bereikbaar.";
}

function pcs_get_availability(string $icsUrl, int $openFrom, int $openTill, int $cacheSeconds = 60): string {
  $cacheFile = __DIR__ . '/cache/availability.json';
  if (!is_dir(dirname($cacheFile))) @mkdir(dirname($cacheFile), 0775, true);

  if (is_file($cacheFile) && (time() - filemtime($cacheFile) < $cacheSeconds)) {
    $cached = json_decode(@file_get_contents($cacheFile), true);
    if (!empty($cached['status'])) return $cached['status'];
  }

  $ics = pcs_fetch_url($icsUrl);
  if ($ics === null) {
    $status = "‚ö†Ô∏è Status onbekend (agenda niet bereikbaar).";
    @file_put_contents($cacheFile, json_encode(['status' => $status], JSON_UNESCAPED_UNICODE));
    return $status;
  }

  $events = pcs_parse_ics_events($ics);
  $status = pcs_availability_label($events, $openFrom, $openTill);
  @file_put_contents($cacheFile, json_encode(['status' => $status], JSON_UNESCAPED_UNICODE));
  return $status;
}

/* ==== Status ophalen ==== */
$AVAIL_STATUS = pcs_get_availability($ICS_URL, $OPEN_FROM, $OPEN_TILL, $CACHE_SECONDS);
?>
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PC Slim ‚Äì Eerlijk advies & snelle hulp</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --primary:#245c8e; --primary-600:#1d4b74; --accent:#f39c12;
      --bg:#f6f8fb; --text:#223041; --muted:#6b778c; --card:#fff;
      --shadow:0 10px 25px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box} html,body{margin:0} body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg);line-height:1.6}
    .container{width:92%;max-width:1200px;margin:0 auto}
    header{position:sticky;top:0;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06);z-index:50}
    .nav{display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#2f76b2);display:grid;place-items:center;color:#fff;font-weight:800}
    .name{font-weight:800;font-size:1.2rem}.name span{color:var(--accent)}
    nav ul{display:flex;gap:22px;list-style:none;margin:0;padding:0}
    nav a{color:var(--text);text-decoration:none;font-weight:600;opacity:.9}
    nav a:hover{opacity:1;color:var(--primary)}
    .hero{background:linear-gradient(180deg,rgba(36,92,142,.9),rgba(36,92,142,.86)),url('https://images.unsplash.com/photo-1518779578993-ec3579fee39f?q=80&w=1600&auto=format&fit=crop') center/cover;padding:80px 0;color:#fff}
    .hero h1{font-size:2.4rem;line-height:1.2;margin:0 0 12px}
    .hero p{opacity:.95;max-width:760px}
    .btn{display:inline-block;padding:12px 18px;border-radius:8px;text-decoration:none;font-weight:700;transition:.25s}
    .btn-primary{background:#fff;color:#0f3960}.btn-primary:hover{filter:brightness(.95)}
    section{padding:70px 0}
    .section-title{text-align:center;margin-bottom:38px}
    .section-title h2{margin:0 0 8px;color:var(--primary)}
    .cards{display:grid;gap:22px}@media(min-width:900px){.cards{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:24px;display:flex;flex-direction:column}
    .card .icon{width:44px;height:44px;border-radius:12px;background:#eef4fb;display:grid;place-items:center;color:var(--primary)}
    .card h3{margin:12px 0 6px}
    .price{color:#1f7f55;font-weight:800;margin-top:auto}
    .pricing{display:grid;gap:22px}@media(min-width:1000px){.pricing{grid-template-columns:repeat(3,1fr)}}
    .price-card{background:#fff;border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .price-top{background:var(--primary);color:#fff;padding:18px;text-align:center}
    .price-body{padding:22px;text-align:center}.money{font-size:2rem;font-weight:800;margin:6px 0 14px}
    .features{list-style:none;margin:0 0 16px;padding:0}.features li{padding:10px 0;border-bottom:1px solid #eef1f7}.features li:last-child{border-bottom:none}
    .price-cta{padding:0 22px 22px;text-align:center}
    .usp{background:var(--primary);color:#fff}.usp .box{background:#ffffff16;border:1px solid #ffffff25;border-radius:14px;padding:22px;text-align:center}
    .usp-grid{display:grid;gap:22px}@media(min-width:980px){.usp-grid{grid-template-columns:repeat(3,1fr)}}
    .contact{display:grid;gap:26px}@media(min-width:980px){.contact{grid-template-columns:1fr 1.2fr}}
    .info h3{color:var(--primary);margin:0 0 6px}.info p{margin:4px 0;color:var(--muted)}
    form{background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:24px}
    label{font-weight:600;display:block;margin:8px 0 6px} input,select,textarea{width:100%;padding:12px 14px;border:1px solid #e4e7ee;border-radius:10px;font-size:1rem}
    textarea{min-height:130px}
    footer{background:#1c2633;color:#cbd3df;padding:50px 0 28px;margin-top:50px}
    .foot{display:grid;gap:26px}@media(min-width:1000px){.foot{grid-template-columns:2fr 1fr 1fr 1fr}}
    .copy{border-top:1px solid #2a3545;margin-top:22px;padding-top:16px;text-align:center;color:#94a1b2}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;background:#fff;color:#245c8e;font-weight:800;font-size:.8rem}
  </style>
</head>
<body>

<header>
  <div class="container nav">
    <div class="brand"><div class="logo">PC</div><div class="name">PC <span>Slim</span></div></div>
    <nav aria-label="Hoofdmenu">
      <ul>
        <li><a href="#diensten">Diensten</a></li>
        <li><a href="#tarieven">Tarieven</a></li>
        <li><a href="#contact">Contact</a></li>
        <li><a href="#faq">FAQ</a></li>
      </ul>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <span class="badge">Eerlijk advies ‚Ä¢ Snelle hulp</span>
    <h1>Betrouwbare computerhulp zonder vakjargon</h1>
    <p>Windows 11-upgrade of ‚Äì als dat niet kan ‚Äì overstappen op Linux. Duidelijke uitleg en vaste prijsafspraak.</p>
    <a class="btn btn-primary" href="#diensten">Bekijk onze diensten</a>
  </div>
</section>

<section id="diensten">
  <div class="container">
    <div class="section-title">
      <h2>Onze Diensten</h2>
      <p>Complete computerondersteuning voor particulieren en kleine bedrijven.</p>
    </div>

    <div class="cards">
      <article class="card">
        <div class="icon"><i class="fa-solid fa-rotate"></i></div>
        <h3>Upgrade-service</h3>
        <p>Compatibiliteitscheck en installatie. Back-up, uitvoering en nazorg geregeld.</p>
        <div class="price">vanaf ‚Ç¨ 59</div>
      </article>
      <article class="card">
        <div class="icon"><i class="fa-brands fa-linux"></i></div>
        <h3>Linux Oplossingen</h3>
        <p>Installatie, migratie van bestanden en korte training. Vlot en veilig op oudere pc‚Äôs.</p>
        <div class="price">vanaf ‚Ç¨ 79</div>
      </article>
      <article class="card">
        <div class="icon"><i class="fa-solid fa-user-shield"></i></div>
        <h3>Beveiliging & Gemak</h3>
        <p>Back-ups, updates en wachtwoordbeheer. Rust en zekerheid zonder gedoe.</p>
        <div class="price">op maat</div>
      </article>
    </div>
  </div>
</section>

<section id="tarieven">
  <div class="container">
    <div class="section-title">
      <h2>Transparante Prijzen</h2>
      <p>Heldere tarieven zonder verborgen kosten.</p>
    </div>

    <div class="pricing">
      <div class="price-card">
        <div class="price-top"><h3>Windows 11 Upgrade</h3></div>
        <div class="price-body">
          <div class="money">‚Ç¨59‚Äì‚Ç¨89</div>
          <ul class="features">
            <li>Compatibiliteitscheck</li><li>Uitvoeren upgrade</li><li>Data behouden</li><li>Na-controle</li>
          </ul>
        </div>
        <div class="price-cta"><a class="btn" style="background:var(--primary);color:#fff" href="#contact">Afspraak maken</a></div>
      </div>

      <div class="price-card">
        <div class="price-top"><h3>Linux Installatie</h3></div>
        <div class="price-body">
          <div class="money">‚Ç¨79</div>
          <ul class="features">
            <li>Installatie Linux</li><li>Keuze uit distributies</li><li>Bestanden migreren</li><li>Basistraining (1 uur)</li>
          </ul>
        </div>
        <div class="price-cta"><a class="btn" style="background:var(--accent);color:#fff" href="#contact">Afspraak maken</a></div>
      </div>

      <div class="price-card">
        <div class="price-top"><h3>PC Slim Support</h3></div>
        <div class="price-body">
          <div class="money">‚Ç¨9,95/maand</div>
          <ul class="features">
            <li>Onbeperkt advies</li><li>Hulp op afstand</li><li>20 minuten per maand</li><li>Geen voorrijkosten</li>
          </ul>
        </div>
        <div class="price-cta"><a class="btn" style="background:var(--primary);color:#fff" href="#contact">Abonnement afsluiten</a></div>
      </div>
    </div>
  </div>
</section>

<section id="faq">
  <div class="container">
    <div class="section-title"><h2>Veelgestelde vragen</h2></div>
    <details id="is-windows-10-nog-wel-veilig">
      <summary>Is Windows 10 nog wel veilig?</summary>
      <p>Kort antwoord: ja, <strong>tot oktober 2026</strong> kan Windows 10 nog veilig worden gebruikt via <strong>Extended Security Updates (ESU)</strong>.</p>
      <p>Microsoft stopt op <strong>14 oktober 2025</strong> met de gewone beveiligingsupdates. Met ESU blijf je nog drie jaar extra beveiligingsupdates ontvangen, zodat je tijd hebt om te upgraden naar <strong>Windows 11</strong> of over te stappen op <strong>Linux</strong>.</p>
    </details>
    <details>
      <summary>Wat als Windows 11 niet kan?</summary>
      <p>Dan is Linux vaak de beste optie: snel, veilig en vertrouwd. We zetten je bestanden over en geven een korte uitleg.</p>
    </details>
  </div>
</section>

<section id="contact">
  <div class="container">
    <div class="section-title">
      <h2>Neem contact op</h2>
      <p>Zakelijk en duidelijk. We reageren snel.</p>
    </div>

    <div class="contact">
      <div class="info">
        <h3>Onze gegevens</h3>
        <p><i class="fa-solid fa-phone"></i> 06-12345678</p>
        <p><i class="fa-solid fa-envelope"></i> info@pcslim.nl</p>
        <p><i class="fa-solid fa-location-dot"></i> Regio [Uw Regio]</p>
        <p><i class="fa-regular fa-clock"></i>
          Bereikbaarheid: <strong><?= htmlspecialchars($AVAIL_STATUS, ENT_QUOTES, 'UTF-8'); ?></strong><br>
          <span style="color:#6b778c">Ma‚ÄìVr: <?= sprintf('%02d:00‚Äì%02d:00', $OPEN_FROM, $OPEN_TILL); ?></span>
        </p>
      </div>

      <form method="post" action="/contact_verwerk.php" novalidate>
        <label for="naam">Uw naam</label>
        <input id="naam" name="name" required placeholder="Naam">
        <label for="email">Uw e-mailadres</label>
        <input id="email" name="email" type="email" required placeholder="naam@voorbeeld.nl">
        <label for="bericht">Uw bericht</label>
        <textarea id="bericht" name="message" required placeholder="Beschrijf kort uw vraag of probleem‚Ä¶"></textarea>
        <!-- Honeypot -->
        <input type="text" name="website" style="display:none" autocomplete="off">
        <button class="btn" style="background:var(--primary);color:#fff;margin-top:10px" type="submit">Verstuur bericht</button>
        <p style="color:#6b778c;font-size:.9rem;margin-top:6px">We gebruiken uw gegevens alleen om op uw bericht te reageren.</p>
      </form>
    </div>
  </div>
</section>

<footer role="contentinfo">
  <div class="container">
    <div class="foot">
      <div>
        <div class="brand"><div class="logo">PC</div><div class="name">PC <span>Slim</span></div></div>
        <p style="margin-top:8px">Helder advies en betrouwbare hulp ‚Äì zonder vakjargon.</p>
      </div>
      <div>
        <h4>Diensten</h4>
        <ul style="list-style:none;margin:0;padding:0">
          <li><a href="#diensten" style="color:#cbd3df;text-decoration:none">Upgrade-service</a></li>
          <li><a href="#diensten" style="color:#cbd3df;text-decoration:none">Linux Oplossingen</a></li>
          <li><a href="#diensten" style="color:#cbd3df;text-decoration:none">Beveiliging & Gemak</a></li>
        </ul>
      </div>
      <div>
        <h4>Links</h4>
        <ul style="list-style:none;margin:0;padding:0">
          <li><a href="#tarieven" style="color:#cbd3df;text-decoration:none">Tarieven</a></li>
          <li><a href="#faq" style="color:#cbd3df;text-decoration:none">FAQ</a></li>
          <li><a href="#contact" style="color:#cbd3df;text-decoration:none">Contact</a></li>
        </ul>
      </div>
      <div>
        <h4>Contact</h4>
        <ul style="list-style:none;margin:0;padding:0">
          <li>üìû 06-12345678</li>
          <li>‚úâÔ∏è info@pcslim.nl</li>
          <li>üìç Regio [Uw Regio]</li>
        </ul>
      </div>
    </div>
    <div class="copy">¬© <span id="year"></span> PC Slim. Alle rechten voorbehouden.</div>
  </div>
</footer>

<script>
  // Smooth scroll + huidig jaar
  document.querySelectorAll('header nav a[href^="#"]').forEach(a=>{
    a.addEventListener('click',e=>{
      e.preventDefault();
      document.querySelector(a.getAttribute('href'))?.scrollIntoView({behavior:'smooth'});
    });
  });
  document.getElementById('year').textContent=new Date().getFullYear();
</script>
</body>
</html>
